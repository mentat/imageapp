(function(b){function a(i,l,j,c,k){var e,d,h,g,f;e=document.createElement("canvas");e.style.display="none";document.body.appendChild(e);d=e.getContext("2d");h=new Image();h.onload=function(){var o,m,n;f=Math.min(l/h.width,j/h.height);if(f<1){o=Math.round(h.width*f);m=Math.round(h.height*f)}else{o=h.width;m=h.height}e.width=o;e.height=m;d.drawImage(h,0,0,o,m);g=e.toDataURL(c);g=g.substring(g.indexOf("base64,")+7);g=atob(g);e.parentNode.removeChild(e);k({success:true,data:g})};h.src=i}b.runtimes.Html5=b.addRuntime("html5",{init:function(g,h){var c={},e;function f(m){var k,j,l=[],n;for(j=0;j<m.length;j++){k=m[j];n=b.guid();c[n]=k;l.push(new b.File(n,k.fileName,k.fileSize))}if(l.length){g.trigger("FilesAdded",l)}}function d(){var i;if(window.XMLHttpRequest){i=new XMLHttpRequest();return !!(i.sendAsBinary||i.upload)}return false}if(!d()){h({success:false});return}g.bind("Init",function(n){var r,p=[],m,q,k=n.settings.filters,l,o,j=document.body;r=document.createElement("div");r.id=n.id+"_html5_container";for(m=0;m<k.length;m++){l=k[m].extensions.split(/,/);for(q=0;q<l.length;q++){o=b.mimeTypes[l[q]];if(o){p.push(o)}}}b.extend(r.style,{position:"absolute",background:g.settings.shim_bgcolor||"transparent",width:"100px",height:"100px",overflow:"hidden",zIndex:99999,opacity:g.settings.shim_bgcolor?"":0});r.className="plupload html5";if(g.settings.container){j=document.getElementById(g.settings.container);j.style.position="relative"}j.appendChild(r);r.innerHTML='<input id="'+g.id+'_html5" style="width:100%;" type="file" accept="'+p.join(",")+'" '+(g.settings.multi_selection?'multiple="multiple"':"")+" />";document.getElementById(g.id+"_html5").onchange=function(){f(this.files);this.value=""}});g.bind("PostInit",function(){var i=document.getElementById(g.settings.drop_element);if(i){b.addEvent(i,"dragover",function(j){j.preventDefault()});b.addEvent(i,"drop",function(k){var j=k.dataTransfer;if(j&&j.files){f(j.files)}k.preventDefault()})}});g.bind("Refresh",function(i){var j,k,l;j=document.getElementById(g.settings.browse_button);k=b.getPos(j,document.getElementById(i.settings.container));l=b.getSize(j);b.extend(document.getElementById(g.id+"_html5_container").style,{top:k.y+"px",left:k.x+"px",width:l.w+"px",height:l.h+"px"})});g.bind("UploadFile",function(o,l){var p=new XMLHttpRequest(),q=p.upload,k=o.settings.resize,m,n=0;function i(r){var v="----pluploadboundary"+b.guid(),t="--",u="\r\n",s="";if(o.settings.multipart){p.setRequestHeader("Content-Type","multipart/form-data; boundary="+v);b.each(o.settings.multipart_params,function(x,w){s+=t+v+u+'Content-Disposition: form-data; name="'+w+'"'+u+u;s+=x+u});s+=t+v+u+'Content-Disposition: form-data; name="'+o.settings.file_data_name+'"; filename="'+l.name+'"'+u+"Content-Type: application/octet-stream"+u+u+r+u+t+v+t+u;n=s.length-r.length;r=s}p.sendAsBinary(r)}if(l.status==b.DONE||l.status==b.FAILED||o.state==b.STOPPED){return}if(q){q.onprogress=function(r){l.loaded=r.loaded-n;o.trigger("UploadProgress",l)}}p.onreadystatechange=function(){var r=p.status;if(p.readyState==4){l.status=b.DONE;l.loaded=l.size;o.trigger("UploadProgress",l);o.trigger("FileUploaded",l,{response:p.responseText,status:r});if(r!=200){o.trigger("Error",{code:b.HTTP_ERROR,message:"HTTP Error.",file:l,status:r})}}};var j={};if(!o.settings.multipart){j.name=l.target_name||l.name}p.open("post",b.buildUrl(o.settings.url,j),true);p.setRequestHeader("Content-Type","application/octet-stream");m=c[l.id];if(p.sendAsBinary){if(k&&/\.(png|jpg|jpeg)$/i.test(l.name)){a(m.getAsDataURL(),k.width,k.height,/\.png$/i.test(l.name)?"image/png":"image/jpeg",function(r){if(r.success){l.size=r.data.length;i(r.data)}else{i(m.getAsBinary())}})}else{i(m.getAsBinary())}}else{p.send(m)}});e=!!(File&&File.prototype.getAsDataURL);g.features={dragdrop:window.mozInnerScreenX!==undefined,jpgresize:e,pngresize:e};h({success:true})}})})(plupload);